name: "DevSecOps GÃ¼venlik Pipeline"

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  schedule:
    - cron: '0 0 * * 1'  # Her Pazartesi gÃ¼nÃ¼ Ã§alÄ±ÅŸtÄ±r

jobs:
  initialize:
    name: Pipeline BaÅŸlangÄ±cÄ±
    runs-on: ubuntu-latest
    outputs:
      runtag: ${{ steps.set-runtag.outputs.runtag }}
    steps:
      - name: Runtag OluÅŸtur
        id: set-runtag
        run: |
          echo "runtag=$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
      
      - name: Pipeline Bilgisi
        run: |
          echo "DevSecOps Pipeline baÅŸlatÄ±lÄ±yor"
          echo "Runtag: ${{ steps.set-runtag.outputs.runtag }}"
          echo "Branch: ${{ github.ref }}"
          echo "Commit: ${{ github.sha }}"

  secret-scan:
    name: GitLeaks - SÄ±r TaramasÄ±
    needs: initialize
    runs-on: ubuntu-latest
    steps:
      - name: Repoyu Kontrol Et
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: GitLeaks ile SÄ±zÄ±ntÄ± TaramasÄ±
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  sast:
    name: Statik Kod Analizi
    needs: initialize
    runs-on: ubuntu-latest
    steps:
      - name: Repoyu Kontrol Et
        uses: actions/checkout@v4

      - name: Node.js Ayarla
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
        run: npm ci

      - name: ESLint ile Kod Analizi
        run: npm run lint || true

      - name: Semgrep ile Kod Analizi
        uses: semgrep/semgrep-action@v1
        with:
          publishToken: ${{ secrets.SEMGREP_APP_TOKEN }}
          publishDeployment: ${{ secrets.SEMGREP_DEPLOYMENT_ID }}
          config: >-
            p/owasp-top-ten
            p/javascript
            p/nodejs
            p/typescript
            p/angular
          generateSarif: "1"
          output: semgrep.sarif

      - name: Semgrep SonuÃ§larÄ±nÄ± YÃ¼kle
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: semgrep.sarif
          category: semgrep

  dependency-check:
    name: BaÄŸÄ±mlÄ±lÄ±k GÃ¼venlik TaramasÄ±
    needs: initialize
    runs-on: ubuntu-latest
    steps:
      - name: Repoyu Kontrol Et
        uses: actions/checkout@v4

      - name: Node.js Ayarla
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: BaÄŸÄ±mlÄ±lÄ±klarÄ± YÃ¼kle
        run: npm ci

      - name: NPM Audit
        run: npm audit --production --audit-level=high || true

      - name: OWASP Dependency-Check
        uses: dependency-check/Dependency-Check_Action@main
        id: dependency-check
        with:
          project: "juice-shop"
          path: "."
          format: "HTML"
          out: "./reports"
          args: >
            --enableRetired
            --suppression="./.dependency-check-suppression.xml"
            --failOnCVSS=7
            --exclude="**/frontend/node_modules/**"

      - name: Dependency-Check Raporu YÃ¼kle
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-report
          path: ./reports/dependency-check-report.html

  sbom:
    name: SBOM OluÅŸturma
    needs: [initialize, dependency-check]
    runs-on: ubuntu-latest
    steps:
      - name: Repoyu Kontrol Et
        uses: actions/checkout@v4

      - name: Syft ile SBOM OluÅŸtur
        uses: anchore/sbom-action@v0
        with:
          format: cyclonedx-json
          output-file: ./sbom-${{ needs.initialize.outputs.runtag }}.cyclonedx.json

      - name: SBOM DosyasÄ±nÄ± ArÅŸivle
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx-${{ needs.initialize.outputs.runtag }}
          path: ./sbom-${{ needs.initialize.outputs.runtag }}.cyclonedx.json

  container-scan:
    name: Docker Ä°maj TaramasÄ±
    needs: [initialize, sbom]
    runs-on: ubuntu-latest
    steps:
      - name: Repoyu Kontrol Et
        uses: actions/checkout@v4

      - name: Docker Build
        run: |
          docker build -t juice-shop:${{ needs.initialize.outputs.runtag }} .
          docker tag juice-shop:${{ needs.initialize.outputs.runtag }} juice-shop:latest

      - name: Trivy ile Docker Ä°maj TaramasÄ±
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'juice-shop:${{ needs.initialize.outputs.runtag }}'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Trivy SonuÃ§larÄ±nÄ± YÃ¼kle
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: 'trivy-results.sarif'
          category: trivy

  dast:
    name: ZAP Dinamik Tarama
    needs: [initialize, container-scan]
    runs-on: ubuntu-latest
    steps:
      - name: Repoyu Kontrol Et
        uses: actions/checkout@v4

      - name: Docker Compose ile UygulamayÄ± BaÅŸlat
        run: |
          docker run -d --name juice-shop-${{ needs.initialize.outputs.runtag }} -p 3000:3000 juice-shop:${{ needs.initialize.outputs.runtag }}
          sleep 30  # UygulamanÄ±n baÅŸlamasÄ± iÃ§in bekle

      - name: ZAP Full Scan
        uses: zaproxy/action-full-scan@v0.9.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j'
          allow_issue_writing: true

      - name: ZAP Raporunu ArÅŸivle
        uses: actions/upload-artifact@v4
        with:
          name: zap-full-scan-report
          path: zap-full-scan-report.html

  security-report:
    name: GÃ¼venlik Raporu
    needs: [initialize, secret-scan, sast, dependency-check, sbom, container-scan, dast]
    runs-on: ubuntu-latest
    steps:
      - name: Repoyu Kontrol Et
        uses: actions/checkout@v4

      - name: RaporlarÄ± Ä°ndir
        uses: actions/download-artifact@v4
        with:
          path: ./reports

      - name: Ã–zet GÃ¼venlik Raporu OluÅŸtur
        run: |
          echo "# GÃ¼venlik Tarama SonuÃ§larÄ± - ${{ needs.initialize.outputs.runtag }}" > security-report.md
          echo "## Tarama Ã–zeti" >> security-report.md
          echo "* Tarih: $(date)" >> security-report.md
          echo "* Branch: ${{ github.ref }}" >> security-report.md
          echo "* Commit: ${{ github.sha }}" >> security-report.md
          echo "* Runtag: ${{ needs.initialize.outputs.runtag }}" >> security-report.md
          echo "## Gizli Bilgi TaramasÄ±" >> security-report.md
          echo "GitLeaks taramasÄ± tamamlandÄ±" >> security-report.md
          echo "## Statik Kod Analizi" >> security-report.md
          echo "Semgrep taramasÄ± tamamlandÄ±" >> security-report.md
          echo "## BaÄŸÄ±mlÄ±lÄ±k TaramasÄ±" >> security-report.md
          echo "NPM Audit ve OWASP Dependency-Check tamamlandÄ±" >> security-report.md
          echo "## SBOM" >> security-report.md
          echo "Syft ile SBOM oluÅŸturma tamamlandÄ±" >> security-report.md
          echo "## Docker Ä°maj TaramasÄ±" >> security-report.md
          echo "Trivy taramasÄ± tamamlandÄ±" >> security-report.md
          echo "## DAST TaramasÄ±" >> security-report.md
          echo "ZAP taramasÄ± tamamlandÄ±" >> security-report.md

      - name: GÃ¼venlik Raporunu ArÅŸivle
        uses: actions/upload-artifact@v4
        with:
          name: security-report-${{ needs.initialize.outputs.runtag }}
          path: security-report.md

  notify:
    name: Bildirim GÃ¶nder
    needs: [initialize, security-report]
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: Bildirim Durumu
        run: |
          if [[ "${{ job.status }}" == "success" ]]; then
            echo "Pipeline baÅŸarÄ±yla tamamlandÄ±! ğŸš€"
            echo "Runtag: ${{ needs.initialize.outputs.runtag }}"
          else
            echo "Pipeline'da hatalar oluÅŸtu! âš ï¸"
            echo "Runtag: ${{ needs.initialize.outputs.runtag }}"
          fi
